<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/core-input/core-input.html">

<link rel="import" href="../../elements/fow-rest-service/fow-rest-service.html">
<link rel="import" href="../../elements/fow-card-preview/fow-card-preview.html">
<link rel="import" href="../../elements/fow-open-sans/fow-open-sans.html">

<polymer-element name="fow-card-list" attributes="cards nameFilter token">
  <template>
    <style>
      
      :host {
        display: block;
        width: 86%;
        margin-left: 7%;
        text-align: left;
        background-color: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 5px;
        font-family: Open Sans;
      }

      .sheader{
        position: relative;
        top: 10px;
      }

      .tools{
        background-color: rgba(255,255,255,0.3);
        color: #000;
        margin: 10px;
        padding: 10px;
        border-radius: 5px;
      }

      .textSearch, .attributes, .type, .rarity, .expansion, .cost{
        background-color: rgba(255,255,255,0.3);
        border-radius: 10px;
        margin: 4px;
      }

      .cost{
        padding: 10px;
      }

      .title{
        text-transform: uppercase;
        font-size: 1.3em;
      }

      .textInput{
        color: #000;
        margin: 10px;
      }

      html /deep/ paper-input[focused] .floated-label {
          /* floating label color when the input has focus */
          color: #fff;
      }

      /* Attribute Radio Button Colors */
      paper-radio-button.light::shadow #ink[checked] {
        color: #ff0;
      }
      paper-radio-button.light::shadow #onRadio {
        background-color:  #ff8;
      }

      paper-radio-button.dark::shadow #ink[checked] {
        color: #111;
      }
      paper-radio-button.dark::shadow #onRadio {
        background-color:  #111;
      }

      paper-radio-button.wind::shadow #ink[checked] {
        color: #2e2;
      }
      paper-radio-button.wind::shadow #onRadio {
        background-color:  #2e2;
      }

      paper-radio-button.fire::shadow #ink[checked] {
        color: #f44;
      }
      paper-radio-button.fire::shadow #onRadio {
        background-color:  #f44;
      }

      paper-radio-button.water::shadow #ink[checked] {
        color: #57f;
      }
      paper-radio-button.water::shadow #onRadio {
        background-color:  #57f;
      }

      paper-radio-button.all::shadow #ink[checked] {
        color: #fff;
      }
      paper-radio-button.all::shadow #onRadio {
        background-color:  #fff;
      }

      paper-radio-button.default::shadow #ink[checked] {
        color: #fff;
      }
      paper-radio-button.default::shadow #onRadio {
        background-color:  #fff;
      }

      core-icon:hover{
        color: #fff;
      }

      input{
        width: 20px;
        text-align: center;
      }
    </style>

    <fow-rest-service type="cards" items="{{cards}}" auto="true" token="{{token}}">
    </fow-rest-service>

    <div class="tools">
      <div class="sheader" layout horizontal center center-justified>
        <core-icon icon="social:whatshot"></core-icon> <div class="title">Search Filters</div> <core-icon icon="social:whatshot"></core-icon>
      </div>
      <br />
      <div class="textSearch" layout horizontal center center-justified>
        <paper-input class="textInput"
        autofocus
        floatinglabel 
        label="Name" 
        layout vertical 
        inputValue="{{nameFilter}}">
        </paper-input>
        <paper-input class="textInput"
        floatinglabel 
        label="Card Text" 
        layout vertical 
        inputValue="{{descriptionFilter}}">
        </paper-input>
      </div>
      <div class="attributes" layout horizontal center center-justified>
        <paper-radio-group selected="{{attributeFilter}}">
          <paper-radio-button class="light" name="light" label="Light"></paper-radio-button>
          <paper-radio-button class="dark" name="dark" label="Dark"></paper-radio-button>
          <paper-radio-button class="wind" name="wind" label="Wind"></paper-radio-button>
          <paper-radio-button class="water" name="water" label="Water"></paper-radio-button>
          <paper-radio-button class="fire" name="fire" label="Fire"></paper-radio-button>
          <paper-radio-button class="all" name="radio_all" label="All"></paper-radio-button>
        </paper-radio-group>
      </div>
      <div class="type" layout horizontal center center-justified>
        <paper-radio-group selected="{{typeFilter}}">
          <paper-radio-button class="default" name="resonator" label="Resonator"></paper-radio-button>
          <paper-radio-button class="default" name="spell" label="Instant/Chant"></paper-radio-button>
          <paper-radio-button class="default" name="addition" label="Addition"></paper-radio-button>
          <paper-radio-button class="default" name="ruler" label="Ruler / JRuler"></paper-radio-button>
          <paper-radio-button class="default" name="radio_all" label="All"></paper-radio-button>
        </paper-radio-group>
      </div>
      <div class="rarity" layout horizontal center center-justified>
        <paper-radio-group selected="{{rarityFilter}}">
          <paper-radio-button class="default" name="sr" label="SR"></paper-radio-button>
          <paper-radio-button class="default" name="r" label="R"></paper-radio-button>
          <paper-radio-button class="default" name="u" label="U"></paper-radio-button>
          <paper-radio-button class="default" name="c" label="C"></paper-radio-button>
          <paper-radio-button class="default" name="radio_all" label="All"></paper-radio-button>
        </paper-radio-group>
      </div>
      <div class="expansion" layout horizontal center center-justified>
        <paper-radio-group selected="{{expansionFilter}}">
          <paper-radio-button class="default" name="Dawn of Valhalla" label="Dawn of Valhalla"></paper-radio-button>
          <paper-radio-button class="default" name="War of Valhalla" label="War of Valhalla"></paper-radio-button>
          <paper-radio-button class="default" name="The Shaft of Light of Valhalla" label="The Shaft of Light of Valhalla"></paper-radio-button>
          <paper-radio-button class="default" name="The Crimson Moon Fairy Tale" label="The Crimson Moon Fairy Tale"></paper-radio-button>
          <paper-radio-button class="default" name="radio_all" label="All"></paper-radio-button>
        </paper-radio-group>
      </div>
      <div class="cost" layout horizontal center center-justified>
        <input value="{{minCost}}"></input> 
        &nbsp <= Total Cost <= &nbsp
        <input value="{{maxCost}}"></input>
      </div>
      <div layout vertical center>
        <core-icon icon="undo" on-tap="{{resetFilters}}">
        </core-icon>
      </div>
    </div>

    <template repeat="{{card in filteredCards}}">
      <fow-card-preview 
        card="{{card}}">
      </fow-card-preview>
    </template>


  </template>
  <script>

    (function () {
      'use strict';

      Polymer("fow-card-list",{

        observe: {
          "cards nameFilter descriptionFilter attributeFilter typeFilter rarityFilter expansionFilter minCost maxCost" : "updateFilteredCards"
        },

        created: function (){
          this.filteredCards = [];
          this.resetFilters();
        },

        resetFilters: function(){
          this.nameFilter = "";
          this.descriptionFilter = "";
          this.attributeFilter = "radio_all";
          this.typeFilter = "radio_all";
          this.rarityFilter = "radio_all";
          this.expansionFilter = "radio_all";
          this.minCost = "0";
          this.maxCost = "20";
        },

        updateFilteredCards: function(){
          this.filteredCards = this.filterOnText(this.cards, "Name", this.nameFilter);

          this.filteredCards = this.filterOnText(this.filteredCards, "Cardtext", this.descriptionFilter);

          this.filteredCards = this.filterOnText(this.filteredCards, "Attribute", this.attributeFilter);

          this.filteredCards = this.filterOnText(this.filteredCards, "Type", this.typeFilter);

          this.filteredCards = this.filterOnText(this.filteredCards, "Rarity", this.rarityFilter);

          this.filteredCards = this.filterOnText(this.filteredCards, "Expansion", this.expansionFilter);

          this.filteredCards = this.filterOnRange(this.filteredCards, "Total Cost", this.minCost, this.maxCost);
        },

        filterOnRange: function(cardList, key, min, max){
          var min = parseInt(min);
          var max = parseInt(max);

          var self = this;

          return cardList.filter(
            
            function(card){
              return (card[key] >= min) && (card[key] <= max);
            }
          
          );
        },

        filterOnText: function(cardList, key, filterString){
          if(filterString === "" || filterString === "radio_all"){
            return cardList;
          } 
          else {
            var self = this;

            return cardList.filter(
              
              function(card){
                return self.strictMatch(card[key], filterString);
              }
            
            );
          }
        },

        strictMatch:  function(text, textToSearch){
          return ( text.toUpperCase().indexOf(textToSearch.toUpperCase()) > -1 );
        },

        fuzzyMatch: function(text, textToSearch){
          var search = textToSearch.toUpperCase();
          var text = text.toUpperCase();

          var j = -1; // remembers position of last found character

          // consider each search character one at a time
          for (var i = 0; i < search.length; i++) {
            var l = search[i];
            if (l == ' ') {
              continue;     // ignore spaces
            }
            
            j = text.indexOf(l, j+1);     // search for character & update position
            if (j == -1) {
              return false;  // if it's not found, exclude this item
            }
          }
          return true;
        }

      });

    })();
  </script>
</polymer-element>
