<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../elements/elements.html">

<polymer-element name="fow-deck-update" attributes="deck token toast">
  <template>
    <style>
      :host {
        display: block;
        margin-top: 14px;
        margin-right: 5px;
        background-color: rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 5px;
        height: 100%;
      }
      .titleType{
        width: 100%;
        max-width: 500px;
        text-align: left;
        font-weight: bold;
        margin-left: -4px;
        margin-top: 6px;
      }
    </style>

    <fow-rest-service id="updateDeckService" 
        type="decks" 
        auto="false" 
        token="{{token}}" 
        method="PUT"
        on-rest-error="{{errorHandler}}"
        on-rest-response="{{successHandler}}">
    </fow-rest-service>

    <template if="{{deck}}">

      <div layout vertical center> 
        <core-icon-button 
          on-tap="{{updateDeck}}" 
          icon="save">
        </core-icon-button>
        <div>
          <!--<core-icon-button icon="create">
          </core-icon-button>
          {{deck.title}}-->
           <input class="text-input" value="{{deck.title}}"/>
        </div> 

        
        <div class="privacy" layout horizontal center center-justified>
          <paper-radio-group selected="{{deck.privacy}}">
            <paper-radio-button class="private" name="private" label="private"></paper-radio-button>
            <paper-radio-button class="password" name="password" label="password"></paper-radio-button>
            <paper-radio-button class="public" name="public" label="public"></paper-radio-button>
            <paper-radio-button class="anonimous" name="anonimous" label="anonimous"></paper-radio-button>
          </paper-radio-group>
        </div>

        <fow-card-picker 
          on-add="{{deckChanged}}"
          deck="{{deck}}">
        </fow-card-picker>

        <div><h3>{{deck.title}} ({{deck.cards.length}})</h3></div>
        <div class="titleType">Ruler ({{rulers.length}})</div>
        <template repeat="{{deckCard in rulers}}">
          <fow-deck-update-card deckCard="{{deckCard}}"></fow-deck-update-card>
        </template>
        <div class="titleType">Magic Stones ({{stones.length}})</div>
        <template repeat="{{deckCard in stones}}">
          <fow-deck-update-card deckCard="{{deckCard}}"></fow-deck-update-card>
        </template>
        <div class="titleType">Resonators ({{resonators.length}})</div>
        <template repeat="{{deckCard in resonators}}">
          <fow-deck-update-card deckCard="{{deckCard}}"></fow-deck-update-card>
        </template>
        <div class="titleType">Additions ({{additions.length}})</div>
        <template repeat="{{deckCard in additions}}">
          <fow-deck-update-card deckCard="{{deckCard}}"></fow-deck-update-card>
        </template>
        <div class="titleType">Spells ({{spells.length}})</div>
        <template repeat="{{deckCard in spells}}">
          <fow-deck-update-card deckCard="{{deckCard}}"></fow-deck-update-card>
        </template>
      </div>
    </template>
    <template if="{{!deck}}">
      <div layout vertical center> 
        Select a deck >>>
      </div>
    </template>
  </template>
  <script>
    (function () {

      Polymer("fow-deck-update",{  
        
        rulers: null,

        resonators: null,

        additions: null,

        spells: null,

        stones: null,

        deckChanged: function(){
          this.rulers = this.filterOnText(this.deck.cards, "Type", "Ruler");
          this.resonators = this.filterOnText(this.deck.cards, "Type", "Resonator");
          this.additions = this.filterOnText(this.deck.cards, "Type", "Addition");
          this.spells = this.filterOnText(this.deck.cards, "Type", "Spell");
          this.stones = this.filterOnText(this.deck.cards, "Type", "Stone");
        },

        updateDeck: function(){
          this.$.updateDeckService.body = JSON.stringify(this.deck);
          this.$.updateDeckService.go();
        },

        successHandler: function(event){
          if(this.toast){
            this.toast.text="Deck updated!";
            this.toast.show();
            this.selectedDeck = event.detail.detail.response[0];
          }
        },

        errorHandler: function(event){
          if(this.toast){
            this.toast.text="There was a problem updating the deck.";
            this.toast.show();
          }
        },

        filterOnText: function(cardList, key, filterString, remaining){
          if(filterString === "" || filterString === "radio_all"){
            return cardList;
          } 
          else if(cardList){
            var self = this;

            return cardList.filter(
              
              function(deckCard){
                //console.log(card);
                if( self.strictMatch(deckCard.card[key], filterString) ){
                  return true;
                } else if(remaining){ 
                  remaining.push(deckCard);
                }
                
                return false; 
              }
            
            );
          } else {
            return [];
          }
        },

        strictMatch:  function(text, textToSearch){
          if(text && textToSearch){
            return ( text.toUpperCase().indexOf(textToSearch.toUpperCase()) > -1 );
          } else{
            return false;
          }
        }

      });

    })();
  </script>
</polymer-element>
