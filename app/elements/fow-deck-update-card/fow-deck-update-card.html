<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-icon/core-icon.html">
<link rel="import" href="../../bower_components/core-tooltip/core-tooltip.html">

<polymer-element name="fow-deck-update-card" attributes="deck deckCard isSide">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        margin-top: 1px;
      }
      .deckCard{
        width: 100%;
        max-width: 500px;
        text-align: left;
        padding: 4px;
        color: black;
        background-color: rgb(100,100,100);
        border-radius: 2px;
      }
      .cardQty
      {
        width: 30px;
        margin: 2px;
        margin-left: 10px;
        text-align: center;
      }

      .Fire{
        background-color: rgb(190,100,100);
      }
      .Dark{
        color: white;
        background-color: rgb(55,55,55);
      }
      .Light{
        background-color: rgb(180,170,160);
      }
      .Wind{
        background-color: #00CC99;
      }
      .Water{
        background-color: #9DCEFF;
      }

      .FireCircle{
        color: white;
        background-color: rgb(160,20,20);
      }
      .DarkCircle{
        color: white;
        background-color: rgb(11,11,11);
      }
      .LightCircle{
        background-color: rgb(240,230,220);
      }
      .WindCircle{
        color: white;
        background-color: #393;
      }
      .WaterCircle{
        color: white;
        background-color: #36C;
      }
      .VoidCircle{
        color: white;
        background-color: rgb(140,140,140);
      }

      .delete{
        height: 24px;
        width: 24px;
        cursor: pointer;
      }
      .circle{
        text-align: center;
        font-size: 0.8em;
        height: 18px;
        width: 17px;
        padding-left: 1px;
        border-radius: 9px;
        margin: 1px;
      }
      .tooltip-image
      {
        height: 250px;
        width: 180px;
      }
      .tooltip-container{
        width: 100%;
        max-width: 500px;
      }
    </style>
    <div layout vertical center>
      <div class="deckCard {{deckCard.card.Attribute}}">
        <core-tooltip class="tooltip-container" position="top">
          <div layout horizontal center>
            <div flex>
              <b>{{deckCard.qty}}</b>x {{deckCard.card.Name}} 
            </div>
            <template if="{{deckCard.card['Free Cost'] != 0}}">
              <div class="circle VoidCircle">{{deckCard.card["Free Cost"]}}</div>
            </template>

            <template if="{{deckCard.card['Attribute Cost'] != 0}}">
              <div class="circle {{deckCard.card.Attribute + 'Circle'}}">{{deckCard.card["Attribute Cost"]}}</div>
            </template>

            <input class="cardQty" type="number" value="{{deckCard.qty}}"/>
            <core-icon
              class="delete"
              on-tap="{{removeCard}}" 
              icon="cancel"
              title="Remove">
            </core-icon>

            <template if="{{!isSide}}">
              <core-icon
                class="delete"
                on-tap="{{moveToSide}}" 
                icon="get-app"
                title="Move to Side">
              </core-icon>
            </template>
            <template if="{{isSide}}">
              <core-icon
                class="delete"
                on-tap="{{moveToDeck}}" 
                icon="file-upload"
                title="Move to Deck">
              </core-icon>
            </template>
          </div>
          <div tip>
            <img class="tooltip-image" src="{{ '../images' + deckCard.card['Image path'] }}">
          </div>

        </core-tooltip>
      </div>
    </div>
  </template>
  <script>
    (function () {

      Polymer({
        observe:{
          "deckCard.qty" : "needsUpdate"
        },

        removeCard: function(){

          if(this.isSide){
            var objIndex = this.deck.side.indexOf(this.deckCard);
            this.deck.side.splice(objIndex,1);
          } else {
            var objIndex = this.deck.cards.indexOf(this.deckCard);
            this.deck.cards.splice(objIndex,1);
          }
          this.fire("update");
        },

        addCardToCardArray: function(card, deckCardsArray){

          var deckCardToUpdate = null;
          //search if there is a card with the same code
          for (var i = deckCardsArray.length - 1; i >= 0; i--) {
            var deckCard = deckCardsArray[i];
            if(deckCard.card.code === card.code){
              deckCardToUpdate = deckCard;
            }
          };

          //update card or add card
          if(deckCardToUpdate){
            deckCardToUpdate.qty++;
          } else {
            deckCardsArray.push({card: card, qty: 1});
          }

        },

        moveCardFromArrayToArray: function(fromArray, toArray){
          if(this.deckCard.qty === 1){
            var objIndex = fromArray.indexOf(this.deckCard);
            fromArray.splice(objIndex,1);
          } else {
            this.deckCard.qty--;
          }
          this.addCardToCardArray(this.deckCard.card, toArray);
        },

        moveToDeck: function(){
          this.moveCardFromArrayToArray(this.deck.side, this.deck.cards);
          this.fire("update");
        },

        moveToSide: function(){
          this.moveCardFromArrayToArray(this.deck.cards, this.deck.side);
          this.fire("update");
        },

        needsUpdate: function(oldVal, newVal){
          if(oldVal){
            this.fire("update");
          }
        }
      });

    })();
  </script>
</polymer-element>
